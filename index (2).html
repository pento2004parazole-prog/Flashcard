<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Title for the PWA and browser tab -->
    <title>Flashcard Web App</title>

    <!-- CRITICAL FIX: Placeholder variables to prevent Firebase errors on GitHub Pages. 
         These allow the app to run without a real database setup. -->
    <script>
        const __app_id = 'github-pages-test-app';
        const __firebase_config = '{}';
        const __initial_auth_token = '';
    </script>

    <!-- Load Tailwind CSS for styling and responsiveness -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Dark background */
            color: #f3f4f6; /* Light text */
            -webkit-tap-highlight-color: transparent; /* Remove tap highlights on mobile */
        }
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        .flashcard-front {
            transform: rotateY(0deg);
        }
        .flashcard-back {
            /* Ensures the back is initially hidden and correctly oriented for the flip */
            transform: rotateY(180deg); 
        }
        .card-container {
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        
        /* FIX: Target the card-container when it *itself* has the flip-card class */
        .card-container.flip-card {
            transform: rotateY(180deg);
        }
        
        .flashcard-front, .flashcard-back {
            backface-visibility: hidden;
        }
        .focus-ring-white:focus {
            outline: 2px solid white;
            outline-offset: 2px;
        }
    </style>

    <!-- PWA MANIFEST LINK -->
    <link rel="manifest" href="./flashcard_manifest.json">

    <!-- PWA SERVICE WORKER REGISTRATION -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Note: The path depends on your deployment structure.
                navigator.serviceWorker.register('./flashcard_service_worker.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</head>
<body class="p-4 min-h-screen">
    <div id="app" class="max-w-xl mx-auto">
        <!-- Main Application Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-extrabold text-blue-400">Flashcard Pro</h1>
            <p class="text-gray-400 text-sm">Offline PWA for Learning</p>
        </header>

        <!-- Main Content Area -->
        <div id="content">
            <!-- Loading and Error State -->
            <div id="loading" class="text-center p-8">
                <p class="text-blue-300">Loading App Data...</p>
                <div class="mt-4 w-8 h-8 border-4 border-blue-500 border-t-transparent border-solid rounded-full animate-spin mx-auto"></div>
            </div>

            <!-- Custom Message Box/Modal -->
            <div id="message-box-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
                <div class="bg-gray-800 p-6 rounded-xl card-shadow max-w-sm w-full">
                    <h3 id="message-box-title" class="text-xl font-bold mb-3 text-blue-400"></h3>
                    <p id="message-box-body" class="text-gray-300 mb-6"></p>
                    <button id="message-box-confirm" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">OK</button>
                    <button id="message-box-cancel" class="w-full mt-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition hidden">Cancel</button>
                </div>
            </div>

            <!-- View Containers -->
            <div id="folder-list-view" class="view"></div>
            <div id="card-list-view" class="view hidden"></div>
            <div id="card-practice-view" class="view hidden"></div>
            <div id="card-edit-view" class="view hidden"></div>
        </div>
    </div>

    <!-- JavaScript logic -->
    <script>
        // DOM Elements
        const app = document.getElementById('app');
        const contentDiv = document.getElementById('content');
        const loadingDiv = document.getElementById('loading');
        const folderListView = document.getElementById('folder-list-view');
        const cardListView = document.getElementById('card-list-view');
        const cardPracticeView = document.getElementById('card-practice-view');
        const cardEditView = document.getElementById('card-edit-view');

        // Message Box Elements
        const messageBoxModal = document.getElementById('message-box-modal');
        const messageBoxTitle = document.getElementById('message-box-title');
        const messageBoxBody = document.getElementById('message-box-body');
        const messageBoxConfirm = document.getElementById('message-box-confirm');
        const messageBoxCancel = document.getElementById('message-box-cancel');

        // Global State Variables
        let currentView = 'folder-list';
        let folders = [];
        let cards = {}; // {folderId: [card1, card2, ...]}
        let selectedFolderId = null;
        let selectedCardIndex = 0;
        
        // Storage Keys
        const FOLDERS_KEY = 'flashcard_folders';
        const CARDS_KEY = 'flashcard_cards';

        /**
         * Custom Promise-based Message Box (replaces alert/confirm)
         * @param {string} title - The title of the box.
         * @param {string} body - The main message body.
         * @param {boolean} isConfirmation - If true, shows a Cancel button.
         * @returns {Promise<boolean>} - Resolves true for Confirm/OK, false for Cancel.
         */
        function showMessageBox(title, body, isConfirmation = false) {
            return new Promise(resolve => {
                messageBoxTitle.textContent = title;
                messageBoxBody.textContent = body;
                messageBoxCancel.classList.toggle('hidden', !isConfirmation);

                const handleConfirm = () => {
                    messageBoxModal.classList.add('hidden');
                    messageBoxConfirm.removeEventListener('click', handleConfirm);
                    messageBoxCancel.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    messageBoxModal.classList.add('hidden');
                    messageBoxConfirm.removeEventListener('click', handleConfirm);
                    messageBoxCancel.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                messageBoxConfirm.addEventListener('click', handleConfirm);
                if (isConfirmation) {
                    messageBoxCancel.addEventListener('click', handleCancel);
                }

                messageBoxModal.classList.remove('hidden');
            });
        }

        // --- Utility Functions ---

        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
        }
        
        // Data Handling - Using localStorage as fallback for GitHub Pages
        const storage = {
            async get(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.error("Error reading from localStorage:", e);
                    return null;
                }
            },
            async set(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {
                    console.error("Error writing to localStorage:", e);
                }
            }
        };


        async function loadData() {
            try {
                // Initialize global state from storage
                folders = (await storage.get(FOLDERS_KEY)) || [];
                cards = (await storage.get(CARDS_KEY)) || {};
                console.log("Data loaded.", {folders, cards});
            } catch (error) {
                console.error("Failed to load initial data:", error);
                showMessageBox("Data Load Error", "Could not load data from storage. Starting fresh.");
            }
        }

        async function saveData() {
            try {
                await storage.set(FOLDERS_KEY, folders);
                await storage.set(CARDS_KEY, cards);
            } catch (error) {
                console.error("Failed to save data:", error);
                showMessageBox("Data Save Error", "Could not save data to storage.");
            }
        }

        // --- View Navigation ---

        function setView(viewName) {
            folderListView.classList.add('hidden');
            cardListView.classList.add('hidden');
            cardPracticeView.classList.add('hidden');
            cardEditView.classList.add('hidden');

            switch (viewName) {
                case 'folder-list':
                    folderListView.classList.remove('hidden');
                    renderFolderList();
                    break;
                case 'card-list':
                    cardListView.classList.remove('hidden');
                    renderCardList();
                    break;
                case 'practice':
                    cardPracticeView.classList.remove('hidden');
                    renderCardPractice();
                    break;
                case 'edit':
                    cardEditView.classList.remove('hidden');
                    renderCardEdit();
                    break;
                default:
                    console.error("Unknown view:", viewName);
            }
            currentView = viewName;
        }

        // --- Folder List View (Home Screen) ---

        function createFolderItem(folder) {
            const cardCount = (cards[folder.id] || []).length;
            
            const folderDiv = document.createElement('div');
            folderDiv.className = 'flex justify-between items-center bg-gray-800 p-4 rounded-xl mb-3 card-shadow cursor-pointer transition transform hover:scale-[1.01]';
            
            const textDiv = document.createElement('div');
            textDiv.className = 'flex-grow min-w-0';
            textDiv.innerHTML = `
                <h2 class="text-lg font-semibold text-white truncate">${folder.name}</h2>
                <p class="text-sm text-gray-400">${cardCount} ${cardCount === 1 ? 'Card' : 'Cards'}</p>
            `;
            textDiv.onclick = () => {
                selectedFolderId = folder.id;
                setView('card-list');
            };
            
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex space-x-2 ml-4 flex-shrink-0';
            
            // Edit Button
            const editBtn = document.createElement('button');
            editBtn.className = 'p-2 rounded-full text-blue-400 hover:bg-gray-700 transition focus-ring-white';
            editBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>
            `;
            editBtn.onclick = async (e) => {
                e.stopPropagation();
                
                // Prompting for new name using a custom prompt/alert since prompt() is banned
                const newName = await new Promise(resolve => {
                    messageBoxTitle.textContent = 'Edit Folder Name';
                    messageBoxBody.innerHTML = `
                        <p class="text-gray-300 mb-2">Enter a new name for the folder:</p>
                        <input id="prompt-input" type="text" value="${folder.name}" class="w-full p-2 rounded-lg bg-gray-700 text-white border-none focus:ring-blue-500 focus:border-blue-500" />
                    `;
                    messageBoxCancel.classList.remove('hidden');

                    const handleConfirm = () => {
                        const input = document.getElementById('prompt-input').value.trim();
                        messageBoxModal.classList.add('hidden');
                        messageBoxConfirm.removeEventListener('click', handleConfirm);
                        messageBoxCancel.removeEventListener('click', handleCancel);
                        resolve(input);
                    };

                    const handleCancel = () => {
                        messageBoxModal.classList.add('hidden');
                        messageBoxConfirm.removeEventListener('click', handleConfirm);
                        messageBoxCancel.removeEventListener('click', handleCancel);
                        resolve(null);
                    };

                    messageBoxConfirm.textContent = 'Confirm';
                    messageBoxCancel.textContent = 'Cancel';
                    messageBoxConfirm.addEventListener('click', handleConfirm);
                    messageBoxCancel.addEventListener('click', handleCancel);
                    messageBoxModal.classList.remove('hidden');
                });
                
                if (newName && newName.length > 0) {
                    folder.name = newName;
                    await saveData();
                    renderFolderList();
                } else if (newName !== null) {
                    // User confirmed but entered nothing.
                    showMessageBox("Name Required", "Folder name cannot be empty.");
                }
            };
            
            // Delete Button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'p-2 rounded-full text-red-400 hover:bg-gray-700 transition focus-ring-white';
            deleteBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            `;
            deleteBtn.onclick = async (e) => {
                e.stopPropagation();
                const confirmed = await showMessageBox('Confirm Delete', `Are you sure you want to delete the folder "${folder.name}" and all ${cardCount} cards?`, true);
                if (confirmed) {
                    folders = folders.filter(f => f.id !== folder.id);
                    delete cards[folder.id];
                    await saveData();
                    renderFolderList();
                }
            };

            buttonContainer.appendChild(editBtn);
            buttonContainer.appendChild(deleteBtn);
            
            folderDiv.appendChild(textDiv);
            folderDiv.appendChild(buttonContainer);
            
            return folderDiv;
        }

        function renderFolderList() {
            folderListView.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-3 text-white">Your Folders</h2>
                    <div id="folder-container"></div>
                    <p id="no-folders-msg" class="text-center text-gray-500 mt-8 hidden">
                        No folders yet. Tap the button below to create your first one!
                    </p>
                </div>
                <button id="add-folder-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-xl shadow-lg transition transform hover:scale-[1.01] focus-ring-white">
                    + Create New Folder
                </button>
            `;

            const folderContainer = document.getElementById('folder-container');
            const noFoldersMsg = document.getElementById('no-folders-msg');

            if (folders.length === 0) {
                noFoldersMsg.classList.remove('hidden');
            } else {
                folders.forEach(folder => {
                    folderContainer.appendChild(createFolderItem(folder));
                });
            }

            document.getElementById('add-folder-btn').onclick = async () => {
                // Prompting for new name using a custom prompt/alert since prompt() is banned
                const folderName = await new Promise(resolve => {
                    messageBoxTitle.textContent = 'New Folder';
                    messageBoxBody.innerHTML = `
                        <p class="text-gray-300 mb-2">Enter a name for your new folder:</p>
                        <input id="prompt-input" type="text" placeholder="Folder Name" class="w-full p-2 rounded-lg bg-gray-700 text-white border-none focus:ring-blue-500 focus:border-blue-500" />
                    `;
                    messageBoxCancel.classList.remove('hidden');
                    
                    const handleConfirm = () => {
                        const input = document.getElementById('prompt-input').value.trim();
                        messageBoxModal.classList.add('hidden');
                        messageBoxConfirm.removeEventListener('click', handleConfirm);
                        messageBoxCancel.removeEventListener('click', handleCancel);
                        resolve(input);
                    };

                    const handleCancel = () => {
                        messageBoxModal.classList.add('hidden');
                        messageBoxConfirm.removeEventListener('click', handleConfirm);
                        messageBoxCancel.removeEventListener('click', handleCancel);
                        resolve(null);
                    };

                    messageBoxConfirm.textContent = 'Confirm';
                    messageBoxCancel.textContent = 'Cancel';
                    messageBoxConfirm.addEventListener('click', handleConfirm);
                    messageBoxCancel.addEventListener('click', handleCancel);
                    messageBoxModal.classList.remove('hidden');
                });
                
                if (folderName && folderName.length > 0) {
                    const newFolder = { id: generateUniqueId(), name: folderName };
                    folders.push(newFolder);
                    cards[newFolder.id] = [];
                    await saveData();
                    renderFolderList();
                } else if (folderName !== null) {
                    // User confirmed but entered nothing.
                    showMessageBox("Name Required", "Folder name cannot be empty.");
                }
            };
        }
        
        // --- Card List View ---

        function createCardListItem(card, index) {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center bg-gray-700 p-3 rounded-lg mb-2 card-shadow';
            li.innerHTML = `
                <span class="text-white text-base truncate flex-grow">${index + 1}. ${card.question}</span>
                <div class="flex space-x-2 ml-4 flex-shrink-0">
                    <button data-action="edit" class="p-1 rounded-full text-yellow-300 hover:bg-gray-600 transition focus-ring-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                    </button>
                    <button data-action="delete" class="p-1 rounded-full text-red-400 hover:bg-gray-600 transition focus-ring-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            `;

            li.querySelector('[data-action="edit"]').onclick = () => {
                selectedCardIndex = index;
                setView('edit');
            };

            li.querySelector('[data-action="delete"]').onclick = async () => {
                const confirmed = await showMessageBox('Confirm Delete', 'Are you sure you want to delete this card?', true);
                if (confirmed) {
                    cards[selectedFolderId].splice(index, 1);
                    await saveData();
                    renderCardList();
                }
            };
            
            return li;
        }

        function renderCardList() {
            const folder = folders.find(f => f.id === selectedFolderId);
            const folderCards = cards[selectedFolderId] || [];
            const cardCount = folderCards.length;
            
            if (!folder) {
                return setView('folder-list');
            }

            cardListView.innerHTML = `
                <button id="back-to-folders" class="mb-4 text-blue-400 hover:text-blue-300 font-semibold flex items-center transition focus-ring-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Folders
                </button>
                <h2 class="text-3xl font-extrabold text-white mb-2 truncate">${folder.name}</h2>
                <p class="text-gray-400 mb-6">${cardCount} ${cardCount === 1 ? 'Card' : 'Cards'}</p>

                <div class="flex space-x-4 mb-6">
                    <button id="add-card-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-xl shadow-lg transition transform hover:scale-[1.01] focus-ring-white">
                        + Add Card
                    </button>
                    <button id="practice-btn" ${cardCount === 0 ? 'disabled' : ''} class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-3 px-4 rounded-xl shadow-lg transition transform hover:scale-[1.01] disabled:opacity-50 focus-ring-white">
                        Start Practice
                    </button>
                </div>
                
                <ul id="card-list" class="space-y-2">
                    <!-- Card items go here -->
                </ul>
                <p id="no-cards-msg" class="text-center text-gray-500 mt-8 hidden">
                    No cards in this folder yet.
                </p>
            `;

            document.getElementById('back-to-folders').onclick = () => setView('folder-list');
            document.getElementById('add-card-btn').onclick = () => {
                selectedCardIndex = -1; // -1 indicates a new card
                setView('edit');
            };
            document.getElementById('practice-btn').onclick = () => {
                if (cardCount > 0) {
                    selectedCardIndex = 0;
                    setView('practice');
                }
            };

            const cardListUl = document.getElementById('card-list');
            const noCardsMsg = document.getElementById('no-cards-msg');

            if (cardCount === 0) {
                noCardsMsg.classList.remove('hidden');
            } else {
                folderCards.forEach((card, index) => {
                    cardListUl.appendChild(createCardListItem(card, index));
                });
            }
        }

        // --- Card Edit View ---

        function renderCardEdit() {
            const folderCards = cards[selectedFolderId] || [];
            const isNewCard = selectedCardIndex === -1;
            let card = isNewCard ? { question: '', answer: '' } : folderCards[selectedCardIndex];

            const title = isNewCard ? 'Add New Card' : 'Edit Card';

            cardEditView.innerHTML = `
                <button id="back-to-cards" class="mb-4 text-blue-400 hover:text-blue-300 font-semibold flex items-center transition focus-ring-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Card List
                </button>

                <h2 class="text-3xl font-extrabold text-white mb-6">${title}</h2>

                <form id="card-edit-form" class="space-y-6">
                    <div>
                        <label for="question" class="block text-sm font-medium text-gray-400 mb-1">Question</label>
                        <textarea id="question" rows="4" class="w-full p-3 rounded-lg bg-gray-700 text-white border-none focus:ring-blue-500 focus:border-blue-500 resize-none card-shadow" required>${card.question}</textarea>
                    </div>
                    <div>
                        <label for="answer" class="block text-sm font-medium text-gray-400 mb-1">Answer</label>
                        <textarea id="answer" rows="4" class="w-full p-3 rounded-lg bg-gray-700 text-white border-none focus:ring-blue-500 focus:border-blue-500 resize-none card-shadow" required>${card.answer}</textarea>
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-xl shadow-lg transition transform hover:scale-[1.01] focus-ring-white">
                        ${isNewCard ? 'Save Card' : 'Update Card'}
                    </button>
                </form>
            `;

            document.getElementById('back-to-cards').onclick = () => setView('card-list');
            
            document.getElementById('card-edit-form').onsubmit = async (e) => {
                e.preventDefault();
                const question = document.getElementById('question').value.trim();
                const answer = document.getElementById('answer').value.trim();

                if (!question || !answer) {
                    return showMessageBox("Missing Content", "Both the Question and Answer fields are required.");
                }

                if (isNewCard) {
                    cards[selectedFolderId].push({ question, answer });
                    showMessageBox("Success", "Card saved successfully!");
                } else {
                    folderCards[selectedCardIndex] = { question, answer };
                    showMessageBox("Success", "Card updated successfully!");
                }
                
                await saveData();
                setView('card-list');
            };
        }

        // --- Card Practice View ---

        function renderCardPractice() {
            const folderCards = cards[selectedFolderId] || [];
            
            if (folderCards.length === 0) {
                return setView('card-list');
            }

            const currentCard = folderCards[selectedCardIndex];
            const totalCards = folderCards.length;
            
            cardPracticeView.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <button id="back-to-cards" class="text-blue-400 hover:text-blue-300 font-semibold flex items-center transition focus-ring-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        Exit Practice
                    </button>
                    <span id="card-counter" class="text-lg font-bold text-yellow-400">${selectedCardIndex + 1} / ${totalCards}</span>
                </div>

                <!-- Flashcard Display -->
                <!-- Removed inline ontouchstart to standardize event handling -->
                <div id="flashcard" class="h-96 perspective [perspective:1000px] mb-8">
                    <div id="card-container" class="card-container relative w-full h-full">
                        <!-- Card Front (Question) -->
                        <div id="card-front" class="flashcard-front absolute w-full h-full bg-gray-800 rounded-2xl card-shadow p-6 flex flex-col items-center justify-center text-center cursor-pointer transition transform hover:scale-[1.01] focus-ring-white">
                            <p class="text-sm text-gray-400 mb-2 font-medium">QUESTION</p>
                            <div class="text-2xl font-extrabold text-white overflow-y-auto max-h-full">${currentCard.question}</div>
                        </div>
                        <!-- Card Back (Answer) -->
                        <div id="card-back" class="flashcard-back absolute w-full h-full bg-blue-800 rounded-2xl card-shadow p-6 flex flex-col items-center justify-center text-center cursor-pointer transition transform hover:scale-[1.01] focus-ring-white">
                            <p class="text-sm text-blue-300 mb-2 font-medium">ANSWER</p>
                            <div class="text-2xl font-extrabold text-white overflow-y-auto max-h-full">${currentCard.answer}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Practice Controls -->
                <div class="flex justify-between space-x-4">
                    <button id="prev-card-btn" ${selectedCardIndex === 0 ? 'disabled' : ''} class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-4 rounded-xl shadow-lg transition transform hover:scale-[1.01] disabled:opacity-50 focus-ring-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" /></svg>
                    </button>
                    <button id="flip-card-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-xl shadow-lg transition transform hover:scale-[1.01] focus-ring-white">
                        Flip
                    </button>
                    <button id="next-card-btn" ${selectedCardIndex === totalCards - 1 ? 'disabled' : ''} class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-4 rounded-xl shadow-lg transition transform hover:scale-[1.01] disabled:opacity-50 focus-ring-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" /></svg>
                    </button>
                </div>

                <div class="mt-4 text-center text-gray-500 text-sm">Tap the card or use the Flip button</div>
            `;

            const cardContainer = document.getElementById('card-container');
            const flashcardDiv = document.getElementById('flashcard');

            // Toggle card flip on tap
            const flipCard = () => {
                // This toggles the 'flip-card' class on the container, which the CSS now correctly targets.
                cardContainer.classList.toggle('flip-card');
            };

            document.getElementById('flip-card-btn').onclick = flipCard;
            cardContainer.onclick = flipCard;

            // Navigation
            document.getElementById('back-to-cards').onclick = () => setView('card-list');
            
            document.getElementById('prev-card-btn').onclick = () => {
                selectedCardIndex = Math.max(0, selectedCardIndex - 1);
                renderCardPractice();
            };

            document.getElementById('next-card-btn').onclick = () => {
                selectedCardIndex = Math.min(totalCards - 1, selectedCardIndex + 1);
                renderCardPractice();
            };

            // Mobile Swipe/Touch Controls (for easier mobile use)
            let touchstartX = 0;
            let touchendX = 0;

            const checkDirection = () => {
                // If it's a small movement (a tap), don't navigate
                if (Math.abs(touchendX - touchstartX) < 50) {
                    return;
                }

                if (touchendX < touchstartX) { // Swipe Left (Next Card)
                    if (selectedCardIndex < totalCards - 1) {
                        selectedCardIndex++;
                        renderCardPractice();
                    }
                } else if (touchendX > touchstartX) { // Swipe Right (Previous Card)
                    if (selectedCardIndex > 0) {
                        selectedCardIndex--;
                        renderCardPractice();
                    }
                }
            };
            
            flashcardDiv.addEventListener('touchstart', e => {
                touchstartX = e.changedTouches[0].screenX;
            });

            flashcardDiv.addEventListener('touchend', e => {
                touchendX = e.changedTouches[0].screenX;
                checkDirection();
            });

        }


        // --- Initialization ---

        async function initApp() {
            try {
                // Show loading screen
                loadingDiv.classList.remove('hidden');
                
                // 1. Load data from storage
                await loadData();

                // 2. Hide loading screen and show the default view
                loadingDiv.classList.add('hidden');
                setView('folder-list');

            } catch (error) {
                console.error("App initialization failed:", error);
                loadingDiv.innerHTML = `<p class="text-red-500">Failed to initialize app. See console for details.</p>`;
            }
        }

        // Start the application when the window loads
        window.onload = initApp;

    </script>
</body>
</html>

